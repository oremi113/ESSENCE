<!DOCTYPE html>
<!--
  ESSENCE Step 8: System States Library (Screens 1â€“10)
  Built: February 2026
  Primary reference: Step 5 Message Creation (essence-message-creation-final.html)
  Secondary reference: Step 6 Memory Shelf (essence-memory-shelf-step6-v2-final.html)
  Source: Master Spec V4.3, Chapter 16 + Preservation Guarantees Addendum
  
  SCREENS:
  1. App Loading â€” Splash â†’ Stone Reveal â†’ Idle Ready (3 states)
  2. Content Loading â€” Skeleton â†’ Loaded â†’ Buffering â†’ Buffer Done (4 states)
  3. Voice Processing â€” 0% â†’ 45% â†’ Taking Longer â†’ 85% â†’ Complete â†’ Return (6 states)
  4. Message Generation â€” Generating â†’ Delayed â†’ Delayed Again â†’ Saving â†’ Partial â†’ Saved (6 states)
  5. Empty Shelf â€” No Messages â†’ First Message Arrived (2 states)
  6. Error States â€” Mic Denied â†’ Mic Unavailable â†’ Recording Failed (3 states)
  7. Network/Connection â€” Offline â†’ Connection Lost â†’ Reconnected â†’ Sync In Progress (4 states)
  8. Upload/Storage â€” Upload Failed â†’ Storage Full â†’ Upload Queued (3 states)
  9. Account/Auth â€” Session Expired â†’ Account Suspended â†’ Payment Lapsed (3 states)
  10. Rare Edge Cases â€” Generation Failed â†’ Audio Unavailable â†’ Maintenance (3 states)
  
  Total: 37 distinct system states
-->
<!--
  GLOBAL GUARANTEES (Preservation Addendum):
  - Confirmed states imply persistence
  - Interrupted states prefer resumption
  - Partial completion never implies loss
  - "Finishing up" is a completion state, not an error state
  - Delayed operations shift from progress to presence
  - User exits are never punished with harsher copy
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESSENCE - Step 8: System States (Screens 1â€“10)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* MINERAL & WARMTH Palette â€” identical to Step 5 */
      --cream: #FBF8F4;
      --oat: #F5F0EA;
      --oat-cool: #F0EBE5;
      --sand: #EBE4DC;
      --honey: #E8DCC8;
      
      --charcoal: #1C1A18;
      --graphite: #6B6B6B;
      --ash: #ADA9A5;
      
      --mineral: #7A8088;
      --mineral-dark: #656B73;
      
      --border: rgba(0, 0, 0, 0.06);
      
      /* Typography */
      --font-serif: 'Spectral', Georgia, serif;
      --font-sans: 'Inter', -apple-system, system-ui, sans-serif;
      --font-mono: 'SF Mono', Monaco, monospace;
      
      /* Easing â€” identical to Step 5 */
      --ease-drift: cubic-bezier(0.25, 0.1, 0.25, 1);
      --ease-breath: cubic-bezier(0.4, 0.0, 0.2, 1);
      --ease-out-soft: cubic-bezier(0.0, 0.0, 0.2, 1);
    }

    body {
      font-family: var(--font-sans);
      background: #1A1715;
      color: var(--charcoal);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ========================================
       PHONE FRAME â€” identical to Step 5
       ======================================== */
    .prototype-wrapper {
      max-width: 390px;
      width: 100%;
      background: var(--oat);
      border-radius: 48px;
      overflow: hidden;
      box-shadow: 
        0 0 0 12px #1A1715, 
        0 0 0 14px var(--mineral), 
        0 40px 80px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .phone-frame {
      width: 100%;
      aspect-ratio: 390 / 844;
      background: var(--cream);
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Dynamic Island */
    .dynamic-island {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 126px;
      height: 36px;
      background: #1C1A18;
      border-radius: 20px;
      z-index: 1000;
    }

    /* Status Bar */
    .status-bar {
      height: 54px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 0 28px 8px;
      font-size: 15px;
      font-weight: 600;
      color: var(--charcoal);
      background: var(--cream);
      z-index: 100;
    }

    .status-icons {
      display: flex;
      gap: 5px;
      align-items: center;
      font-size: 14px;
    }

    /* Home Indicator */
    .home-indicator {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 134px;
      height: 5px;
      background: var(--charcoal);
      border-radius: 3px;
      opacity: 0.2;
      z-index: 1000;
    }

    /* ========================================
       SCREENS â€” identical to Step 5
       ======================================== */
    .screen {
      flex: 1;
      display: none;
      flex-direction: column;
      opacity: 0;
      background: var(--cream);
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      transition: opacity 0.4s var(--ease-drift);
    }

    .screen.active {
      display: flex;
      opacity: 1;
    }

    /* ========================================
       HEADER â€” from Step 5
       ======================================== */
    .screen-header {
      padding: 16px 32px 12px;
      text-align: center;
    }

    .label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--graphite);
      margin-bottom: 10px;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.3s var(--ease-out-soft) forwards;
    }

    .screen-title {
      font-family: var(--font-serif);
      font-size: 26px;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 8px;
      line-height: 1.3;
      letter-spacing: -0.01em;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.3s var(--ease-out-soft) 0.1s forwards;
    }

    .screen-subtitle {
      font-size: 15px;
      color: var(--graphite);
      line-height: 1.6;
      max-width: 280px;
      margin: 0 auto;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.3s var(--ease-out-soft) 0.15s forwards;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    /* ========================================
       BREATH STONE â€” from Step 5 exactly
       ======================================== */
    .breath-stone-container {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 24px 20px;
      min-height: 140px;
    }

    .breath-stone {
      border-radius: 50%;
      background: radial-gradient(
        circle at 30% 30%, 
        #FCF4E4,
        #F5ECD8 10%,
        #EFE6D0 22%,
        #E5D8C0 38%,
        #D8CAB0 52%,
        #C4B8A0 68%,
        #AEA090 82%,
        #7D827E
      );
      box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.12),
        inset -20px -20px 40px rgba(28, 26, 24, 0.12),
        inset 20px 20px 40px rgba(251, 248, 244, 0.5);
      position: relative;
      transition: all 0.6s var(--ease-breath);
    }

    /* Stone glow â€” from Step 5 */
    .breath-stone::before {
      content: '';
      position: absolute;
      inset: -40px;
      border-radius: 50%;
      background: radial-gradient(
        circle, 
        rgba(238, 212, 182, var(--glow-intensity, 0.15)), 
        transparent 70%
      );
      animation: stoneBreathe var(--breath-speed, 7s) var(--ease-breath) infinite;
      transition: all 0.6s var(--ease-breath);
    }

    /* Stone shimmer overlay â€” from Step 5 */
    .breath-stone::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.3) 0%,
        transparent 50%,
        transparent 100%
      );
      opacity: 0.6;
    }

    @keyframes stoneBreathe {
      0%, 100% {
        transform: scale(1);
        opacity: 0.4;
      }
      40% {
        transform: scale(1.03);
        opacity: 0.7;
      }
      45% {
        transform: scale(1.03);
        opacity: 0.7;
      }
    }

    /* â”€â”€ STONE STATES â”€â”€ */

    /* Hidden â€” pre-splash only */
    .breath-stone.hidden-state {
      width: 100px;
      height: 100px;
      opacity: 0;
      --glow-intensity: 0;
    }
    .breath-stone.hidden-state::before { animation: none; }

    /* Reveal â€” first app load */
    .breath-stone.reveal {
      width: 100px;
      height: 100px;
      --glow-intensity: 0.10;
      --breath-speed: 7s;
      animation: stoneReveal 1.8s var(--ease-breath) forwards;
    }
    @keyframes stoneReveal {
      0% { opacity: 0; filter: blur(12px); transform: scale(0.85); }
      60% { opacity: 1; filter: blur(0px); transform: scale(1.02); }
      100% { opacity: 1; filter: blur(0px); transform: scale(1); }
    }

    /* Idle â€” from Step 6 (home, empty states, restored) */
    .breath-stone.idle {
      --glow-intensity: 0.08;
      --breath-speed: 7s;
    }

    /* Ready â€” from Step 5 MC-1 */
    .breath-stone.ready {
      width: 90px;
      height: 90px;
      --breath-speed: 6s;
      --glow-intensity: 0.15;
    }

    /* Working â€” from Step 5 MC-2 exactly */
    .breath-stone.working {
      width: 105px;
      height: 105px;
      --breath-speed: 3.25s;
      --glow-intensity: 0.3;
      animation: workingPulse 1.08s var(--ease-breath) infinite;
    }
    @keyframes workingPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.04); }
    }

    /* Celebrate â€” completion, saved */
    .breath-stone.celebrate {
      width: 110px;
      height: 110px;
      --breath-speed: 5s;
      --glow-intensity: 0.28;
      animation: shimmerPulse 0.6s var(--ease-breath) forwards;
    }
    @keyframes shimmerPulse {
      0% { transform: scale(1); --glow-intensity: 0.2; }
      50% { transform: scale(1.06); --glow-intensity: 0.4; }
      100% { transform: scale(1); --glow-intensity: 0.28; }
    }

    /* Gentle â€” Step 8 unique: errors, offline, denied */
    .breath-stone.gentle {
      width: 95px;
      height: 95px;
      --breath-speed: 6.5s;
      --glow-intensity: 0.10;
      opacity: 0.85;
    }

    /* Infused â€” from Step 5 MC-4 (post-save) */
    .breath-stone.infused {
      width: 100px;
      height: 100px;
      --breath-speed: 8s;
      --glow-intensity: 0.2;
    }

    /* ========================================
       CONTENT AREA â€” from Step 5
       ======================================== */
    .content-area {
      flex: 1;
      padding: 0 28px 24px;
      display: flex;
      flex-direction: column;
    }

    /* Centered content variant (for generating/processing screens) */
    .generating-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 32px;
    }

    .generating-title {
      font-family: var(--font-serif);
      font-size: 24px;
      color: var(--charcoal);
      margin-top: 24px;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.3s var(--ease-out-soft) 0.3s forwards;
    }

    .generating-subtitle {
      font-size: 15px;
      color: var(--graphite);
      line-height: 1.6;
      margin-top: 10px;
      max-width: 260px;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.3s var(--ease-out-soft) 0.45s forwards;
    }

    .generating-patience {
      font-size: 13px;
      color: var(--ash);
      font-style: italic;
      margin-top: 8px;
      opacity: 0;
      animation: fadeIn 0.3s var(--ease-out-soft) 0.6s forwards;
    }

    /* ========================================
       FOOTER / CTA â€” from Step 5
       ======================================== */
    .footer {
      padding: 16px 28px 20px;
      background: var(--cream);
    }

    .btn {
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border: none;
      cursor: pointer;
      transition: all 0.2s var(--ease-drift);
      border-radius: 12px;
      padding: 16px 28px;
      width: 100%;
      text-align: center;
    }

    .btn-primary {
      background: var(--mineral);
      color: var(--cream);
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--mineral-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .btn-primary:disabled {
      background: var(--sand);
      color: var(--ash);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      color: var(--graphite);
      padding: 12px 28px;
      font-size: 13px;
      margin-top: 10px;
    }
    .btn-secondary:hover {
      color: var(--charcoal);
    }

    /* Save shimmer â€” from Step 5 Phase 2 */
    .btn-primary.saving {
      position: relative;
      overflow: hidden;
      opacity: 0.7;
      pointer-events: none;
    }
    .btn-primary.saving::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmerBtn 1.2s var(--ease-drift) infinite;
    }
    @keyframes shimmerBtn {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* ========================================
       PROGRESS BAR
       ======================================== */
    .progress-container {
      width: 100%;
      max-width: 260px;
      margin: 20px auto 0;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
      color: var(--graphite);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--sand);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--mineral);
      border-radius: 3px;
      transition: width 1.2s var(--ease-breath);
    }

    /* Indeterminate */
    .progress-bar.indeterminate .progress-fill {
      width: 35%;
      animation: indeterminate 1.8s var(--ease-breath) infinite;
    }
    @keyframes indeterminate {
      0% { transform: translateX(-120%); }
      100% { transform: translateX(380%); }
    }

    /* ========================================
       PROCESSING STAGES
       ======================================== */
    .processing-stages {
      display: flex;
      flex-direction: column;
      gap: 14px;
      width: 100%;
      max-width: 240px;
      margin: 24px auto 0;
      text-align: left;
    }

    .stage {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--ash);
      transition: all 0.5s var(--ease-drift);
    }

    .stage-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--sand);
      transition: all 0.5s var(--ease-drift);
      flex-shrink: 0;
    }

    .stage.active { color: var(--charcoal); font-weight: 500; }
    .stage.active .stage-dot {
      background: var(--mineral);
      box-shadow: 0 0 8px rgba(122, 128, 136, 0.4);
    }

    .stage.complete { color: var(--graphite); }
    .stage.complete .stage-dot { background: var(--mineral); opacity: 0.6; }

    /* ========================================
       SKELETON SHIMMER â€” from Step 6
       ======================================== */
    .skeleton-card {
      background: var(--oat);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
    }

    .skeleton-line {
      height: 12px;
      background: linear-gradient(90deg, var(--sand) 0%, var(--honey) 40%, var(--sand) 80%);
      background-size: 200% 100%;
      animation: shimmer 1.8s var(--ease-drift) infinite;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .skeleton-line:last-child { margin-bottom: 0; }
    .skeleton-line.short { width: 55%; }
    .skeleton-line.medium { width: 75%; }
    .skeleton-line.xs { height: 8px; width: 40%; }

    .skeleton-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(90deg, var(--sand) 0%, var(--honey) 40%, var(--sand) 80%);
      background-size: 200% 100%;
      animation: shimmer 1.8s var(--ease-drift) infinite;
      flex-shrink: 0;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* ========================================
       TOAST â€” from Step 5 MC-4
       ======================================== */
    .toast-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-bottom: 80px;
      z-index: 500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s var(--ease-out-soft);
    }

    .toast-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .toast-card {
      background: var(--cream);
      width: 80%;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 6px 22px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .toast-title {
      font-family: var(--font-serif);
      font-size: 20px;
      color: var(--charcoal);
      margin-bottom: 8px;
    }

    .toast-subtitle {
      font-size: 14px;
      color: var(--graphite);
    }

    /* Chip toast (mineral, for confirmations) */
    .chip-toast {
      position: absolute;
      top: 68px;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: var(--charcoal);
      color: var(--cream);
      padding: 10px 20px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: all 0.35s var(--ease-out-soft);
      z-index: 50;
      white-space: nowrap;
    }

    .chip-toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ========================================
       MESSAGE CARD â€” from Step 6 exactly
       ======================================== */
    .message-card {
      background: linear-gradient(to bottom, var(--oat) 0%, #F3EDE6 100%);
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow:
        inset 0 1px 2px rgba(232, 220, 200, 0.15),
        0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all 200ms var(--ease-breath);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .message-card:hover {
      transform: translateY(-2px);
      background: linear-gradient(to bottom, #F2EBE4 0%, #F0E8E0 100%);
      box-shadow:
        inset 0 1px 2px rgba(232, 220, 200, 0.2),
        0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .card-recipient {
      text-align: left;
      font-size: 18px;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 12px;
    }

    .card-excerpt {
      font-size: 18px;
      line-height: 1.8;
      color: var(--charcoal);
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-shadow: 0 0.5px 1px rgba(232, 220, 200, 0.15);
    }

    .card-metadata {
      font-size: 14px;
      color: var(--ash);
      margin-bottom: 16px;
      line-height: 1.6;
      letter-spacing: 0.01em;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 48px;
    }

    .btn-play {
      background: var(--mineral);
      border: none;
      color: white;
      font-size: 14px;
      cursor: pointer;
      padding: 10px 18px;
      border-radius: 6px;
      transition: all 180ms var(--ease-breath);
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-sans);
      font-weight: 600;
    }

    .btn-play::before {
      content: 'â–·';
      font-size: 16px;
      margin-right: -2px;
    }

    .btn-play:hover {
      background: var(--mineral-dark);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    /* First-message highlight â€” from Step 5 Home B */
    .first-message-card {
      background: var(--cream);
      border: 1px solid var(--sand);
      border-radius: 12px;
      padding: 18px 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      opacity: 0;
      transform: translateY(20px);
    }

    .first-message-card.settle {
      animation: settleCard 0.5s var(--ease-out-soft) forwards;
    }

    @keyframes settleCard {
      0% { opacity: 0; transform: translateY(20px); }
      60% { opacity: 1; transform: translateY(-4px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .first-message-badge {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--graphite);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .first-message-badge::before { content: 'â˜…'; font-size: 10px; }

    .first-message-recipient {
      font-size: 16px;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 2px;
    }

    .first-message-type {
      font-size: 14px;
      color: var(--graphite);
      margin-bottom: 12px;
    }

    .first-message-preview {
      font-family: var(--font-serif);
      font-size: 15px;
      color: var(--charcoal);
      line-height: 1.6;
      margin-bottom: 14px;
      font-style: italic;
    }

    .first-message-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .first-message-play {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--mineral);
      font-size: 14px;
      font-weight: 500;
    }

    .first-message-timestamp {
      font-size: 12px;
      color: var(--ash);
    }

    /* ========================================
       EMPTY STATE â€” from Step 6
       ======================================== */
    .empty-title {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 12px;
      letter-spacing: -0.01em;
    }

    .empty-body {
      font-size: 16px;
      line-height: 1.7;
      color: var(--graphite);
      max-width: 280px;
      margin: 0 auto 20px;
    }

    .empty-promise {
      font-size: 14px;
      line-height: 1.6;
      color: var(--ash);
      max-width: 260px;
      margin: 0 auto 28px;
      font-style: italic;
    }

    /* ========================================
       SPLASH
       ======================================== */
    .splash-wordmark {
      font-family: var(--font-serif);
      font-size: 28px;
      font-weight: 600;
      color: var(--charcoal);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeInUp 0.8s var(--ease-out-soft) 0.3s forwards;
    }

    .splash-tagline {
      font-size: 13px;
      color: var(--ash);
      letter-spacing: 0.04em;
      margin-top: 12px;
      opacity: 0;
      animation: fadeIn 0.6s var(--ease-out-soft) 0.8s forwards;
    }

    /* ========================================
       BUFFER DOTS
       ======================================== */
    .buffer-dots {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 20px;
    }

    .buffer-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--mineral);
      opacity: 0.3;
      animation: bufferPulse 1.4s var(--ease-breath) infinite;
    }
    .buffer-dot:nth-child(2) { animation-delay: 0.2s; }
    .buffer-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bufferPulse {
      0%, 100% { opacity: 0.2; transform: scale(0.8); }
      50% { opacity: 0.8; transform: scale(1.2); }
    }

    /* ========================================
       STATE TOGGLE CONTROLS
       ======================================== */
    .state-controls {
      padding: 10px 20px 14px;
      background: var(--oat);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
      flex-shrink: 0;
    }

    .state-btn {
      background: var(--cream);
      border: 1px solid var(--sand);
      color: var(--graphite);
      font-family: var(--font-sans);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 6px 12px;
      border-radius: 100px;
      cursor: pointer;
      transition: all 150ms var(--ease-drift);
      white-space: nowrap;
    }

    .state-btn:hover { border-color: var(--mineral); }

    .state-btn.active {
      background: var(--mineral);
      color: var(--cream);
      border-color: var(--mineral);
    }

    /* ========================================
       NAVIGATION â€” from Step 5 nav-helper
       ======================================== */
    .nav-helper {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      background: rgba(28, 26, 24, 0.9);
      padding: 10px 16px;
      border-radius: 30px;
      z-index: 2000;
    }

    .nav-btn {
      padding: 8px 14px;
      background: var(--mineral);
      color: var(--cream);
      border: none;
      border-radius: 6px;
      font-family: var(--font-sans);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s var(--ease-drift);
    }

    .nav-btn:hover {
      background: var(--cream);
      color: var(--charcoal);
    }

    .nav-btn.active {
      background: var(--cream);
      color: var(--charcoal);
    }

    /* ========================================
       prefers-reduced-motion (Ch. 16.15)
       ======================================== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="prototype-wrapper">
    <div class="phone-frame">
      <div class="dynamic-island"></div>
      
      <div class="status-bar">
        <span>9:41</span>
        <div class="status-icons">
          <span>ðŸ“¶</span>
          <span>ðŸ”‹</span>
        </div>
      </div>

      <!-- ==========================================
           SCREEN 1: APP LOADING
           States: splash, reveal, ready
           ========================================== -->
      <div class="screen active" id="screen-1"></div>

      <!-- ==========================================
           SCREEN 2: CONTENT LOADING
           States: skeleton, loaded, buffering, buffer-done
           ========================================== -->
      <div class="screen" id="screen-2"></div>

      <!-- ==========================================
           SCREEN 3: VOICE PROCESSING
           States: p0, p45, taking-longer, p85, complete
           ========================================== -->
      <div class="screen" id="screen-3"></div>

      <!-- ==========================================
           SCREEN 4: MESSAGE GENERATION
           States: generating, delayed, saving, saved
           ========================================== -->
      <div class="screen" id="screen-4"></div>

      <!-- ==========================================
           SCREEN 5: EMPTY SHELF
           States: empty, first-message
           ========================================== -->
      <div class="screen" id="screen-5"></div>

      <!-- ==========================================
           SCREEN 6: ERROR STATES
           States: mic-denied, mic-unavailable, recording-failed
           ========================================== -->
      <div class="screen" id="screen-6"></div>

      <!-- ==========================================
           SCREEN 7: NETWORK/CONNECTION STATES
           States: offline, connection-lost, reconnected, sync-progress
           ========================================== -->
      <div class="screen" id="screen-7"></div>

      <!-- ==========================================
           SCREEN 8: UPLOAD/STORAGE STATES
           States: upload-failed, storage-full, upload-queued
           ========================================== -->
      <div class="screen" id="screen-8"></div>

      <!-- ==========================================
           SCREEN 9: ACCOUNT/AUTH STATES
           States: session-expired, account-suspended, payment-lapsed
           ========================================== -->
      <div class="screen" id="screen-9"></div>

      <!-- ==========================================
           SCREEN 10: RARE EDGE CASES
           States: generation-failed, audio-unavailable, maintenance
           ========================================== -->
      <div class="screen" id="screen-10"></div>

      <div class="home-indicator"></div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="nav-helper" style="flex-wrap:wrap; max-width:360px; justify-content:center;">
    <button class="nav-btn active" onclick="goToScreen(1)">S1</button>
    <button class="nav-btn" onclick="goToScreen(2)">S2</button>
    <button class="nav-btn" onclick="goToScreen(3)">S3</button>
    <button class="nav-btn" onclick="goToScreen(4)">S4</button>
    <button class="nav-btn" onclick="goToScreen(5)">S5</button>
    <button class="nav-btn" onclick="goToScreen(6)">S6</button>
    <button class="nav-btn" onclick="goToScreen(7)">S7</button>
    <button class="nav-btn" onclick="goToScreen(8)">S8</button>
    <button class="nav-btn" onclick="goToScreen(9)">S9</button>
    <button class="nav-btn" onclick="goToScreen(10)">S10</button>
  </div>

  <script>
    // ==========================================
    // PLAY ICON SVG (reusable)
    // ==========================================
    const playIconSVG = '<svg width="10" height="12" viewBox="0 0 10 12" fill="none"><path d="M1 1L9 6L1 11V1Z" fill="white" stroke="white" stroke-width="1" stroke-linejoin="round"/></svg>';

    // ==========================================
    // SCREEN RENDERERS
    // Each returns { controls: HTML, content: HTML }
    // ==========================================

    function renderScreen1(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='splash'?'active':''}" onclick="setState(1,'splash')">Splash</button>
          <button class="state-btn ${state==='reveal'?'active':''}" onclick="setState(1,'reveal')">Reveal</button>
          <button class="state-btn ${state==='ready'?'active':''}" onclick="setState(1,'ready')">Ready</button>
        </div>`;

      let content = '';
      if (state === 'splash') {
        content = `
          <div class="generating-content">
            <div class="splash-wordmark">ESSENCE</div>
            <div class="splash-tagline">Capture your voice. Preserve your essence.</div>
          </div>`;
      } else if (state === 'reveal') {
        content = `
          <div class="generating-content">
            <div class="breath-stone-container" style="min-height:160px;">
              <div class="breath-stone reveal" style="width:100px; height:100px;"></div>
            </div>
            <div class="splash-wordmark" style="animation-delay:0.6s;">ESSENCE</div>
            <div class="splash-tagline" style="animation-delay:1.0s;">Preparing your spaceâ€¦</div>
          </div>`;
      } else {
        content = `
          <div class="screen-header">
            <div class="label">WELCOME TO ESSENCE</div>
            <h1 class="screen-title">Your voice holds more power than you realize.</h1>
            <p class="screen-subtitle">Preserve it today. Keep it close for tomorrow.</p>
          </div>
          <div class="breath-stone-container" style="flex:1;">
            <div class="breath-stone ready"></div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Begin</button>
          </div>`;
      }
      return controls + content;
    }

    function renderScreen2(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='skeleton'?'active':''}" onclick="setState(2,'skeleton')">Skeleton</button>
          <button class="state-btn ${state==='loaded'?'active':''}" onclick="setState(2,'loaded')">Loaded</button>
          <button class="state-btn ${state==='buffering'?'active':''}" onclick="setState(2,'buffering')">Buffering</button>
          <button class="state-btn ${state==='buffer-done'?'active':''}" onclick="setState(2,'buffer-done')">Buffer Done</button>
        </div>`;

      let content = '';
      if (state === 'skeleton') {
        content = `
          <div class="screen-header">
            <div class="label">YOUR MESSAGES</div>
          </div>
          <div class="content-area" style="padding-top:8px;">
            ${[1,2,3].map(i => `
              <div class="skeleton-card">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:14px;">
                  <div class="skeleton-circle"></div>
                  <div style="flex:1">
                    <div class="skeleton-line medium"></div>
                    <div class="skeleton-line xs" style="margin-top:6px;"></div>
                  </div>
                </div>
                <div class="skeleton-line" style="width:100%;"></div>
                <div class="skeleton-line medium"></div>
              </div>`).join('')}
          </div>`;
      } else if (state === 'loaded') {
        content = `
          <div class="screen-header">
            <div class="label">YOUR MESSAGES</div>
          </div>
          <div class="content-area" style="padding-top:8px;">
            <div class="message-card">
              <div class="card-recipient">Children</div>
              <div class="card-excerpt">"Hello, my dear ones. I hope this message finds you well. I want you to know how proud I am of the people you have becomeâ€¦"</div>
              <div class="card-metadata">Created 2 weeks ago Â· 0:18</div>
              <div class="card-footer">
                <button class="btn-play"><span>Play</span></button>
              </div>
            </div>
            <div class="message-card">
              <div class="card-recipient">Children</div>
              <div class="card-excerpt">"There are a few things I have learned over the years that I want to share with you. Some of them I wish someone had told me soonerâ€¦"</div>
              <div class="card-metadata">Created 3 weeks ago Â· 0:24</div>
              <div class="card-footer">
                <button class="btn-play"><span>Play</span></button>
              </div>
            </div>
          </div>`;
      } else if (state === 'buffering') {
        content = `
          <div class="generating-content">
            <div class="breath-stone-container" style="min-height:120px; padding:16px;">
              <div class="breath-stone idle" style="width:80px; height:80px;"></div>
            </div>
            <div class="generating-title" style="font-size:20px;">Your message is safe. We are preparing it for playback.</div>
            <div class="buffer-dots" style="margin-top:20px;">
              <div class="buffer-dot"></div>
              <div class="buffer-dot"></div>
              <div class="buffer-dot"></div>
            </div>
          </div>`;
      } else {
        // buffer-done
        content = `
          <div class="chip-toast visible" id="chip-s2">Ready. Final details finishing.</div>
          <div class="screen-header">
            <div class="label">YOUR MESSAGES</div>
          </div>
          <div class="content-area" style="padding-top:8px;">
            <div class="message-card" style="border: 1.5px solid var(--mineral); box-shadow: 0 2px 16px rgba(122,128,136,0.12), inset 0 1px 2px rgba(232,220,200,0.15);">
              <div class="card-recipient">Children</div>
              <div class="card-excerpt">"Hello, my dear ones. I hope this message finds you well. I want you to know how proud I am of the people you have becomeâ€¦"</div>
              <div class="card-metadata">Created 2 weeks ago Â· Ready. Final details finishing.</div>
              <div class="card-footer">
                <button class="btn-play"><span>Play</span></button>
              </div>
            </div>
            <div class="message-card">
              <div class="card-recipient">Children</div>
              <div class="card-excerpt">"There are a few things I have learned over the years that I want to share with youâ€¦"</div>
              <div class="card-metadata">Created 3 weeks ago Â· 0:24</div>
              <div class="card-footer">
                <button class="btn-play"><span>Play</span></button>
              </div>
            </div>
          </div>`;
        // Auto-dismiss chip
        setTimeout(() => {
          const chip = document.getElementById('chip-s2');
          if (chip) chip.classList.remove('visible');
        }, 2200);
      }
      return controls + content;
    }

    function renderScreen3(state) {
      const states = ['p0','p45','taking-longer','p85','complete','return'];
      const labels = ['0%','45%','Longer','85%','Done','Return'];
      const controls = `
        <div class="state-controls">
          ${states.map((s,i) => `<button class="state-btn ${state===s?'active':''}" onclick="setState(3,'${s}')">${labels[i]}</button>`).join('')}
        </div>`;

      const stageStates = {
        'p0': [1,0,0], 'p45': [2,1,0], 'taking-longer': [2,1,0], 'p85': [2,2,1], 'complete': [2,2,2]
      };

      // Â§C.3 â€” Return after leaving during processing
      if (state === 'return') {
        return controls + `
          <div class="generating-content">
            <div class="breath-stone-container" style="min-height:130px; padding:16px;">
              <div class="breath-stone idle" style="width:100px; height:100px;"></div>
            </div>
            <div class="generating-title" style="font-size:20px; margin-top:16px;">Welcome back. We continued preparing your voice while you were away.</div>
            <div class="generating-subtitle">Everything important is safe.</div>
            <div class="progress-container">
              <div class="progress-bar indeterminate">
                <div class="progress-fill"></div>
              </div>
            </div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Continue</button>
            <button class="btn btn-secondary">Return home</button>
          </div>`;
      }

      if (state === 'complete') {
        return controls + `
          <div class="screen-header">
            <div class="label">VOICE PRESERVED</div>
            <h1 class="screen-title">Your voice is now preserved.</h1>
            <p class="screen-subtitle">It is safe, steady, and ready to carry your words forward.</p>
          </div>
          <div class="breath-stone-container" style="flex:1;">
            <div class="breath-stone celebrate"></div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Create your first message</button>
            <button class="btn btn-secondary">Return home</button>
          </div>`;
      }

      const stageNames = ['Analyzing your voice patterns', 'Building your voice profile', 'Finalizing preservation'];
      const ss = stageStates[state];
      const stageClasses = ['','',''];
      ss.forEach((v,i) => { stageClasses[i] = v===2?'complete':v===1?'active':''; });

      let message = 'Your voice is being carefully shaped.';
      let patience = '';
      let showPercent = true;
      let percent = 0;
      let leaveOption = '';

      if (state === 'p0') {
        percent = 0;
      } else if (state === 'p45') {
        percent = 45;
        message = 'We are learning the shape of your voice.';
      } else if (state === 'taking-longer') {
        // Â§C.1/C.2 â€” Exceeds expected timing: drop percentage, shift to presence
        showPercent = false;
        message = 'Your voice is worth the care. We are still with you.';
        patience = 'You can wait here or come back later. Nothing will be lost.';
        // Â§D â€” Allow user to leave without penalty
        leaveOption = '<p style="font-size:13px; color:var(--ash); font-style:italic; margin-top:12px;">If you step away, we\'ll continue preparing this for you.</p><button class="btn btn-secondary" style="margin-top:8px;">Continue later</button>';
      } else if (state === 'p85') {
        percent = 85;
        message = 'Almost there. Your voice is nearly ready.';
      }

      const progressHTML = showPercent ? `
        <div class="progress-container">
          <div class="progress-header">
            <span>Processing</span>
            <span>${percent}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${percent}%;"></div>
          </div>
        </div>` : `
        <div class="progress-container">
          <div class="progress-header">
            <span>Processing</span>
            <span>In progress</span>
          </div>
          <div class="progress-bar indeterminate">
            <div class="progress-fill"></div>
          </div>
        </div>`;

      return controls + `
        <div class="generating-content">
          <div class="breath-stone-container" style="min-height:130px; padding:16px;">
            <div class="breath-stone working"></div>
          </div>
          <div class="generating-title" style="font-size:20px; margin-top:16px;">${message}</div>
          ${patience ? `<div class="generating-patience">${patience}</div>` : ''}
          ${progressHTML}
          <div class="processing-stages">
            ${stageNames.map((name,i) => `
              <div class="stage ${stageClasses[i]}">
                <div class="stage-dot"></div>
                <span>${name}</span>
              </div>`).join('')}
          </div>
          ${leaveOption}
        </div>`;
    }

    function renderScreen4(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='generating'?'active':''}" onclick="setState(4,'generating')">Generating</button>
          <button class="state-btn ${state==='delayed'?'active':''}" onclick="setState(4,'delayed')">Delayed</button>
          <button class="state-btn ${state==='delayed-again'?'active':''}" onclick="setState(4,'delayed-again')">Delayed 2x</button>
          <button class="state-btn ${state==='saving'?'active':''}" onclick="setState(4,'saving')">Saving</button>
          <button class="state-btn ${state==='partial'?'active':''}" onclick="setState(4,'partial')">Partial</button>
          <button class="state-btn ${state==='saved'?'active':''}" onclick="setState(4,'saved')">Saved</button>
        </div>`;

      if (state === 'generating') {
        return controls + `
          <div class="screen-header">
            <div class="label">CREATING</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone working"></div>
            </div>
            <h2 class="generating-title">Your voice is shaping your words.</h2>
            <div class="progress-container" style="margin-top:24px;">
              <div class="progress-bar indeterminate">
                <div class="progress-fill"></div>
              </div>
            </div>
          </div>`;
      }

      // Â§C â€” Delayed: shift from progress to presence, allow leaving (Â§D)
      if (state === 'delayed') {
        return controls + `
          <div class="screen-header">
            <div class="label">CREATING</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone working"></div>
            </div>
            <h2 class="generating-title">Your message is being shaped. We are still with you.</h2>
            <div class="generating-patience">You can wait here or come back later.<br>Nothing will be lost.</div>
          </div>
          <div class="footer">
            <button class="btn btn-secondary">Continue later</button>
          </div>`;
      }

      // Â§E â€” Repeated failure: second exposure softens tone, offers alternatives
      if (state === 'delayed-again') {
        return controls + `
          <div class="screen-header">
            <div class="label">CREATING</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">This is taking longer than expected.</h2>
            <div class="generating-subtitle">If you'd like, you can adjust your message or try again later.<br>Your words are safe.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Edit your message</button>
            <button class="btn btn-secondary">Return home</button>
          </div>`;
      }

      // Â§B â€” Saving is partial success: communicate continuation, not completion
      if (state === 'saving') {
        return controls + `
          <div class="generating-content">
            <div class="breath-stone-container" style="min-height:130px;">
              <div class="breath-stone working" style="width:100px; height:100px; --breath-speed:4s; --glow-intensity:0.22;"></div>
            </div>
            <div class="label" style="margin-top:8px;">YOUR FIRST MESSAGE</div>
            <h2 class="generating-title" style="font-size:22px; margin-top:12px;">This is your voice, speaking to Sarah.</h2>
            <div class="generating-subtitle" style="margin-top:12px;">Your message is saved.<br>We are preparing it for playback.</div>
            <div class="generating-patience" style="margin-top:10px;">If you step away,<br>we'll continue preparing this for you.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary saving">Finishing upâ€¦</button>
          </div>`;
      }

      // Â§B â€” Partial success: user's contribution captured, background work continuing
      if (state === 'partial') {
        return controls + `
          <div class="generating-content">
            <div class="breath-stone-container" style="min-height:130px;">
              <div class="breath-stone idle" style="width:100px; height:100px;"></div>
            </div>
            <div class="label" style="margin-top:8px;">YOUR FIRST MESSAGE</div>
            <h2 class="generating-title" style="font-size:22px; margin-top:12px;">This is your voice, speaking to Sarah.</h2>
            <div class="generating-subtitle" style="margin-top:12px;">Everything important is safe.<br>We are finishing up the last details.</div>
            <div class="generating-patience" style="margin-top:10px;">This will complete shortly.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Return home</button>
          </div>`;
      }

      // saved â€” Â§A.1: confirmed data persists
      setTimeout(() => {
        const toast = document.getElementById('toast-s4');
        if (toast) {
          toast.classList.add('visible');
          setTimeout(() => toast.classList.remove('visible'), 2300);
        }
        const card = document.getElementById('settle-card-s4');
        if (card) {
          setTimeout(() => card.classList.add('settle'), 500);
        }
        const content = document.getElementById('home-b-s4');
        if (content) {
          setTimeout(() => content.style.opacity = '1', 300);
        }
      }, 100);

      return controls + `
        <div class="toast-overlay visible" id="toast-s4" style="z-index:500;">
          <div class="toast-card" style="background:var(--cream); box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.06);">
            <h3 class="toast-title">Message saved</h3>
            <p class="toast-subtitle">Your keepsake is safe.<br>Final details are finishing quietly.</p>
          </div>
        </div>
        <div class="screen-header" style="padding-top:24px;"></div>
        <div class="breath-stone-container" style="min-height:120px;">
          <div class="breath-stone infused"></div>
        </div>
        <div class="content-area" id="home-b-s4" style="opacity:0.4; transition: opacity 0.4s var(--ease-drift); padding-top:4px;">
          <h2 style="font-family:var(--font-serif); font-size:24px; color:var(--charcoal); text-align:center; margin-bottom:20px;">Your space to save what matters</h2>
          <div class="first-message-card" id="settle-card-s4" style="background:var(--cream); box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
            <div class="first-message-badge">Your first message</div>
            <div class="first-message-recipient">To Sarah</div>
            <div class="first-message-type">A message of love</div>
            <p class="first-message-preview">"Happy birthday, sweetheart. I hope this message finds you feeling lovedâ€¦"</p>
            <div class="first-message-footer">
              <span class="first-message-play">â–¶ Play</span>
              <span class="first-message-timestamp">Shaped just now</span>
            </div>
          </div>
        </div>
        <div class="footer" style="background:var(--oat);">
          <button class="btn btn-primary">Create another message</button>
          <button class="btn btn-secondary">View all messages</button>
        </div>`;
    }

    function renderScreen5(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='empty'?'active':''}" onclick="setState(5,'empty')">Empty</button>
          <button class="state-btn ${state==='first-message'?'active':''}" onclick="setState(5,'first-message')">First Message</button>
        </div>`;

      if (state === 'empty') {
        return controls + `
          <div class="generating-content" style="padding:32px 24px;">
            <div class="breath-stone-container" style="min-height:140px;">
              <div class="breath-stone idle" style="width:120px; height:120px;"></div>
            </div>
            <h2 class="empty-title">Your Memory Shelf</h2>
            <p class="empty-body" style="max-width:300px;">
              Your voice messages will gather here. Each one a keepsake that carries your words forward.
            </p>
            <p class="empty-promise" style="max-width:280px;">
              These messages are preserved and protected. They're meant to be kept, not rushed.
            </p>
            <button class="btn btn-primary" style="max-width:300px;">Create your first message</button>
          </div>`;
      }

      // first-message â€” this is a big moment, give it ceremony
      setTimeout(() => {
        const chip = document.getElementById('chip-s5');
        if (chip) {
          chip.classList.add('visible');
          setTimeout(() => chip.classList.remove('visible'), 3200);
        }
        const card = document.getElementById('settle-card-s5');
        if (card) setTimeout(() => card.classList.add('settle'), 500);
      }, 200);

      return controls + `
        <div class="chip-toast" id="chip-s5">Your first message is ready</div>
        <div class="screen-header" style="padding:20px 24px 8px;">
          <div class="label">YOUR MEMORY SHELF</div>
          <h1 class="screen-title" style="font-size:24px;">A voice to carry forward.</h1>
        </div>
        <div class="breath-stone-container" style="min-height:110px; padding:12px;">
          <div class="breath-stone celebrate" style="width:100px; height:100px;"></div>
        </div>
        <div class="content-area" style="padding:0 24px 24px;">
          <div class="first-message-card" id="settle-card-s5">
            <div class="first-message-badge">Your first message</div>
            <div class="first-message-recipient">To Children</div>
            <div class="first-message-type">A warm hello</div>
            <p class="first-message-preview">"Hello, my dear ones. I hope this message finds you wellâ€¦"</p>
            <div class="first-message-footer">
              <span class="first-message-play">â–¶ Play</span>
              <span class="first-message-timestamp">Shaped just now</span>
            </div>
          </div>
          <p style="font-family:var(--font-serif); font-size:16px; color:var(--graphite); text-align:center; margin-top:24px; line-height:1.6; font-style:italic;">This is the beginning of your voice legacy.</p>
        </div>
        <div class="footer" style="padding:12px 24px 20px;">
          <button class="btn btn-primary">Create another message</button>
        </div>`;
    }

    // ==========================================
    // SCREEN 6: ERROR STATES
    // States: mic-denied, mic-unavailable, recording-failed
    // ==========================================
    function renderScreen6(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='mic-denied'?'active':''}" onclick="setState(6,'mic-denied')">Mic Denied</button>
          <button class="state-btn ${state==='mic-unavailable'?'active':''}" onclick="setState(6,'mic-unavailable')">Mic Unavailable</button>
          <button class="state-btn ${state==='recording-failed'?'active':''}" onclick="setState(6,'recording-failed')">Recording Failed</button>
        </div>`;

      // Â§C â€” Permission denied: never imply user fault, guide gently
      if (state === 'mic-denied') {
        return controls + `
          <div class="screen-header">
            <div class="label">MICROPHONE ACCESS</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">We need your permission to hear your voice.</h2>
            <div class="generating-subtitle">You can update this in your device settings. We'll be here when you're ready.</div>
            <div class="generating-patience">Your progress so far is safe.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Open device settings</button>
            <button class="btn btn-secondary">Return home</button>
          </div>`;
      }

      // Mic unavailable: hardware issue, offer alternatives
      if (state === 'mic-unavailable') {
        return controls + `
          <div class="screen-header">
            <div class="label">MICROPHONE</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">We can't detect a microphone right now.</h2>
            <div class="generating-subtitle">This sometimes happens if another app is using it, or if your device's mic needs a moment.<br><br>You can try again, or write your message instead.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Try again</button>
            <button class="btn btn-secondary">Write instead</button>
          </div>`;
      }

      // Â§C â€” Recording failed: acknowledge effort, never imply user fault
      return controls + `
        <div class="screen-header">
          <div class="label">RECORDING</div>
        </div>
        <div class="generating-content">
          <div class="breath-stone-container">
            <div class="breath-stone gentle"></div>
          </div>
          <h2 class="generating-title">Something interrupted your recording.</h2>
          <div class="generating-subtitle">Your earlier progress is still safe. You only need to re-record the last part.</div>
          <div class="generating-patience">Take your time â€” there's no rush.</div>
        </div>
        <div class="footer">
          <button class="btn btn-primary">Try recording again</button>
          <button class="btn btn-secondary">Continue later</button>
        </div>`;
    }

    // ==========================================
    // SCREEN 7: NETWORK/CONNECTION STATES
    // States: offline, connection-lost, reconnected, sync-progress
    // ==========================================
    function renderScreen7(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='offline'?'active':''}" onclick="setState(7,'offline')">Offline</button>
          <button class="state-btn ${state==='connection-lost'?'active':''}" onclick="setState(7,'connection-lost')">Connection Lost</button>
          <button class="state-btn ${state==='reconnected'?'active':''}" onclick="setState(7,'reconnected')">Reconnected</button>
          <button class="state-btn ${state==='sync-progress'?'active':''}" onclick="setState(7,'sync-progress')">Sync In Progress</button>
        </div>`;

      // Â§H â€” Offline: navigation always allowed, additive actions queued
      if (state === 'offline') {
        return controls + `
          <div class="screen-header">
            <div class="label">CONNECTION</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">You're offline right now.</h2>
            <div class="generating-subtitle">Your messages are safe, and anything you save will sync when you're back online.<br><br>You can still browse your messages and drafts.</div>
            <div class="generating-patience">We'll reconnect quietly when your signal returns.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Browse your messages</button>
          </div>`;
      }

      // Â§D â€” Connection lost mid-operation: partial success framing
      if (state === 'connection-lost') {
        return controls + `
          <div class="screen-header">
            <div class="label">CONNECTION</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">We lost connection briefly.</h2>
            <div class="generating-subtitle">Your progress is safe. We'll resume automatically once your connection returns.</div>
            <div class="generating-patience">If you step away, we'll continue preparing this for you.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Wait for reconnection</button>
            <button class="btn btn-secondary">Return home</button>
          </div>`;
      }

      // Reconnected: chip toast, auto-resume
      if (state === 'reconnected') {
        setTimeout(() => {
          const chip = document.getElementById('chip-s7');
          if (chip) {
            chip.classList.add('visible');
            setTimeout(() => chip.classList.remove('visible'), 2800);
          }
        }, 150);

        return controls + `
          <div class="chip-toast" id="chip-s7">Connection restored</div>
          <div class="screen-header">
            <div class="label">CONNECTION</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone idle"></div>
            </div>
            <h2 class="generating-title">Welcome back online.</h2>
            <div class="generating-subtitle">Everything is caught up. You're all set to continue.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Continue</button>
          </div>`;
      }

      // Â§B â€” Sync in progress: "finishing up" language, not "syncing"
      return controls + `
        <div class="screen-header">
          <div class="label">FINISHING UP</div>
        </div>
        <div class="generating-content">
          <div class="breath-stone-container">
            <div class="breath-stone working" style="width:100px; height:100px; --breath-speed:4s; --glow-intensity:0.22;"></div>
          </div>
          <h2 class="generating-title">Catching up on a few things.</h2>
          <div class="generating-subtitle">Your messages are finishing their journey to safe storage. This will only take a moment.</div>
          <div class="generating-patience">If you step away, this will continue in the background.</div>
        </div>
        <div class="footer">
          <button class="btn btn-primary saving">Finishing upâ€¦</button>
        </div>`;
    }

    // ==========================================
    // SCREEN 8: UPLOAD/STORAGE STATES
    // States: upload-failed, storage-full, upload-queued
    // ==========================================
    function renderScreen8(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='upload-failed'?'active':''}" onclick="setState(8,'upload-failed')">Upload Failed</button>
          <button class="state-btn ${state==='storage-full'?'active':''}" onclick="setState(8,'storage-full')">Storage Full</button>
          <button class="state-btn ${state==='upload-queued'?'active':''}" onclick="setState(8,'upload-queued')">Upload Queued</button>
        </div>`;

      // Â§D â€” Upload failed: partial success, retry without re-recording
      if (state === 'upload-failed') {
        return controls + `
          <div class="screen-header">
            <div class="label">UPLOAD</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">Your recording is safe on your device.</h2>
            <div class="generating-subtitle">We'll finish uploading when your connection is stronger. You don't need to re-record anything.</div>
            <div class="generating-patience">This will happen automatically.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Try uploading now</button>
            <button class="btn btn-secondary">Continue later</button>
          </div>`;
      }

      // Storage full: gentle guidance, no blame
      if (state === 'storage-full') {
        return controls + `
          <div class="screen-header">
            <div class="label">STORAGE</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">Your device is running low on space.</h2>
            <div class="generating-subtitle">Your existing messages are safe. To create new ones, you may need to free up some space on your device.</div>
            <div class="generating-patience">Your messages in the cloud are not affected.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Manage storage</button>
            <button class="btn btn-secondary">Return home</button>
          </div>`;
      }

      // Â§H â€” Upload queued (offline): reassurance it will complete
      return controls + `
        <div class="screen-header">
          <div class="label">UPLOAD QUEUED</div>
        </div>
        <div class="generating-content">
          <div class="breath-stone-container">
            <div class="breath-stone idle"></div>
          </div>
          <h2 class="generating-title">Your message is saved and waiting.</h2>
          <div class="generating-subtitle">It will upload automatically when you're back online. Nothing else is needed from you.</div>
          <div class="generating-patience">If you step away, we'll continue preparing this for you.</div>
        </div>
        <div class="footer">
          <button class="btn btn-primary">Return home</button>
        </div>`;
    }

    // ==========================================
    // SCREEN 9: ACCOUNT/AUTH STATES
    // States: session-expired, account-suspended, payment-lapsed
    // ==========================================
    function renderScreen9(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='session-expired'?'active':''}" onclick="setState(9,'session-expired')">Session Expired</button>
          <button class="state-btn ${state==='account-suspended'?'active':''}" onclick="setState(9,'account-suspended')">Account Suspended</button>
          <button class="state-btn ${state==='payment-lapsed'?'active':''}" onclick="setState(9,'payment-lapsed')">Payment Lapsed</button>
        </div>`;

      // Session expired: calm, no data loss implied
      if (state === 'session-expired') {
        return controls + `
          <div class="screen-header">
            <div class="label">SIGN IN</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone idle"></div>
            </div>
            <h2 class="generating-title">For your security, we need you to sign in again.</h2>
            <div class="generating-subtitle">Everything is exactly where you left it. This only takes a moment.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Sign in</button>
          </div>`;
      }

      // Account suspended: empathetic, link to support
      if (state === 'account-suspended') {
        return controls + `
          <div class="screen-header">
            <div class="label">ACCOUNT</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">Your account needs attention.</h2>
            <div class="generating-subtitle">Your messages are safe and protected. Our support team can help you regain full access.</div>
            <div class="generating-patience">Nothing has been lost.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Contact support</button>
          </div>`;
      }

      // Payment lapsed: gentle, no threats, preservation guaranteed
      return controls + `
        <div class="screen-header">
          <div class="label">ACCOUNT</div>
        </div>
        <div class="generating-content">
          <div class="breath-stone-container">
            <div class="breath-stone gentle"></div>
          </div>
          <h2 class="generating-title">Your voice protection has paused.</h2>
          <div class="generating-subtitle">Your messages are still safe. Update your payment to continue creating new messages and keep your voice legacy protected.</div>
          <div class="generating-patience">There's no rush â€” your existing messages aren't going anywhere.</div>
        </div>
        <div class="footer">
          <button class="btn btn-primary">Update payment</button>
          <button class="btn btn-secondary">View your messages</button>
        </div>`;
    }

    // ==========================================
    // SCREEN 10: RARE EDGE CASES
    // States: generation-failed, audio-unavailable, maintenance
    // ==========================================
    function renderScreen10(state) {
      const controls = `
        <div class="state-controls">
          <button class="state-btn ${state==='generation-failed'?'active':''}" onclick="setState(10,'generation-failed')">Generation Failed</button>
          <button class="state-btn ${state==='audio-unavailable'?'active':''}" onclick="setState(10,'audio-unavailable')">Audio Unavailable</button>
          <button class="state-btn ${state==='maintenance'?'active':''}" onclick="setState(10,'maintenance')">Maintenance</button>
        </div>`;

      // Â§G â€” Generation failed: first attempt, acknowledge and offer edit-and-retry
      if (state === 'generation-failed') {
        return controls + `
          <div class="screen-header">
            <div class="label">MESSAGE CREATION</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">We weren't able to finish creating your message this time.</h2>
            <div class="generating-subtitle">Your words are saved â€” you can try again or make a small edit first.</div>
            <div class="generating-patience">Sometimes a second try is all it takes.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Try again</button>
            <button class="btn btn-secondary">Edit your message</button>
          </div>`;
      }

      // Audio unavailable: message safe, playback needs a moment
      if (state === 'audio-unavailable') {
        return controls + `
          <div class="screen-header">
            <div class="label">PLAYBACK</div>
          </div>
          <div class="generating-content">
            <div class="breath-stone-container">
              <div class="breath-stone gentle"></div>
            </div>
            <h2 class="generating-title">This message needs a moment before it can be played.</h2>
            <div class="generating-subtitle">Your message is safe and complete. The audio is still being prepared â€” it will be ready shortly.</div>
            <div class="generating-patience">If you step away, we'll have it ready when you return.</div>
          </div>
          <div class="footer">
            <button class="btn btn-primary">Return to messages</button>
          </div>`;
      }

      // Maintenance: calm, brief, with expected return
      return controls + `
        <div class="screen-header">
          <div class="label">SCHEDULED MAINTENANCE</div>
        </div>
        <div class="generating-content">
          <div class="breath-stone-container">
            <div class="breath-stone idle" style="opacity:0.7;"></div>
          </div>
          <h2 class="generating-title">We're making improvements right now.</h2>
          <div class="generating-subtitle">Your messages are safe and we'll be back shortly. This is expected to take about 30 minutes.</div>
          <div class="generating-patience">Thank you for your patience.</div>
        </div>`;
    }

    // ==========================================
    // STATE ENGINE
    // ==========================================
    let currentScreen = 1;
    const screenStates = {
      1: 'splash', 2: 'skeleton', 3: 'p0', 4: 'generating', 5: 'empty',
      6: 'mic-denied', 7: 'offline', 8: 'upload-failed', 9: 'session-expired', 10: 'generation-failed'
    };
    const renderers = {
      1: renderScreen1, 2: renderScreen2, 3: renderScreen3, 4: renderScreen4, 5: renderScreen5,
      6: renderScreen6, 7: renderScreen7, 8: renderScreen8, 9: renderScreen9, 10: renderScreen10
    };

    function render(screenNum) {
      const screen = document.getElementById(`screen-${screenNum}`);
      const state = screenStates[screenNum];
      screen.innerHTML = renderers[screenNum](state);
      // Screen 4 saved state gets oat background for toast contrast
      if (screenNum === 4 && state === 'saved') {
        screen.style.background = 'var(--oat)';
      } else if (screenNum === 4) {
        screen.style.background = 'var(--cream)';
      }
    }

    function setState(screenNum, state) {
      screenStates[screenNum] = state;
      render(screenNum);
    }

    function goToScreen(n) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`screen-${n}`).classList.add('active');
      currentScreen = n;
      render(n);

      document.querySelectorAll('.nav-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === n - 1);
      });
    }

    // Keyboard nav
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') goToScreen(Math.min(currentScreen + 1, 10));
      if (e.key === 'ArrowLeft') goToScreen(Math.max(currentScreen - 1, 1));
    });

    // Init
    for (let i = 1; i <= 10; i++) render(i);
  </script>
</body>
</html>
